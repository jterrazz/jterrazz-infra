---
# OpenClaw Deployment
# Runs the gateway with signal-cli for Signal messaging
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openclaw
  namespace: platform-automation
  labels:
    app: openclaw
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: openclaw
  template:
    metadata:
      labels:
        app: openclaw
    spec:
      # Seed system dirs so agent-installed packages persist across restarts
      initContainers:
        - name: seed-system
          image: ghcr.io/openclaw/openclaw:2026.2.21
          securityContext:
            runAsUser: 0
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              # Seed /usr/local from image: add new files, keep existing (agent installs)
              echo "Seeding /usr/local..."
              cp -a -n /usr/local/. /persist-usr-local/ 2>/dev/null || true
              # Seed /opt from image
              echo "Seeding /opt..."
              cp -a -n /opt/. /persist-opt/ 2>/dev/null || true
              echo "System seed complete."
          volumeMounts:
            - name: system-usr-local
              mountPath: /persist-usr-local
            - name: system-opt
              mountPath: /persist-opt
        # Setup config from K8s secrets if not exists
        - name: init-config
          image: ghcr.io/openclaw/openclaw:2026.2.21
          securityContext:
            runAsUser: 0
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              CONFIG_DIR=/root/.openclaw
              CONFIG_FILE=$CONFIG_DIR/openclaw.json
              AUTH_DIR=$CONFIG_DIR/agents/main/agent
              AUTH_FILE=$AUTH_DIR/auth-profiles.json

              # Create directories
              mkdir -p $CONFIG_DIR $AUTH_DIR

              # Create openclaw.json if it doesn't exist
              if [ ! -f "$CONFIG_FILE" ]; then
                echo "Creating initial openclaw.json..."
                cat > $CONFIG_FILE << EOF
              {
                "agents": {
                  "defaults": {
                    "workspace": "/root/clawd"
                  }
                },
                "gateway": {
                  "mode": "local",
                  "port": 18789,
                  "bind": "lan",
                  "auth": {
                    "token": "$GATEWAY_TOKEN"
                  }
                }
              }
              EOF
                chmod 600 $CONFIG_FILE
              else
                echo "openclaw.json already exists, skipping..."
              fi

              # Create auth-profiles.json if it doesn't exist
              if [ ! -f "$AUTH_FILE" ]; then
                echo "Creating initial auth-profiles.json..."
                cat > $AUTH_FILE << EOF
              {
                "profiles": {
                  "anthropic:claude-cli": {
                    "type": "oauth",
                    "provider": "anthropic",
                    "accessToken": "$CLAUDE_TOKEN"
                  }
                }
              }
              EOF
                chmod 600 $AUTH_FILE
              else
                echo "auth-profiles.json already exists, skipping..."
              fi

              # Create credentials directory
              mkdir -p $CONFIG_DIR/credentials
              chmod 700 $CONFIG_DIR

              echo "Init complete."
          env:
            - name: GATEWAY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: openclaw-secrets
                  key: GATEWAY_TOKEN
            - name: CLAUDE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: openclaw-secrets
                  key: CLAUDE_TOKEN
          volumeMounts:
            - name: data
              mountPath: /root
            - name: system-usr-local
              mountPath: /usr/local
            - name: system-opt
              mountPath: /opt
      containers:
        - name: openclaw
          # Community image with signal-cli, playwright, etc
          image: ghcr.io/openclaw/openclaw:2026.2.21
          imagePullPolicy: Always
          securityContext:
            runAsUser: 0
          # Run the gateway
          command: ["node"]
          args: ["/app/dist/entry.js", "gateway", "run"]
          ports:
            - name: gateway
              containerPort: 18789
              protocol: TCP
          env:
            - name: NODE_ENV
              value: "production"
            - name: NODE_OPTIONS
              value: "--max-old-space-size=768"
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openclaw-secrets
                  key: CLAUDE_TOKEN
          volumeMounts:
            - name: data
              mountPath: /root
            - name: system-usr-local
              mountPath: /usr/local
            - name: system-opt
              mountPath: /opt
          resources:
            requests:
              cpu: 25m
              memory: 512Mi
            limits:
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /health
              port: gateway
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: gateway
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: openclaw-data
        - name: system-usr-local
          hostPath:
            path: /var/lib/k8s-data/openclaw-system/usr-local
            type: DirectoryOrCreate
        - name: system-opt
          hostPath:
            path: /var/lib/k8s-data/openclaw-system/opt
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: openclaw
  namespace: platform-automation
  labels:
    app: openclaw
spec:
  type: ClusterIP
  ports:
    - name: gateway
      port: 18789
      targetPort: gateway
  selector:
    app: openclaw
