---
# Clawdbot Deployment
# Runs the gateway with signal-cli for Signal messaging
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clawdbot
  namespace: platform-clawdbot
  labels:
    app: clawdbot
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: clawdbot
  template:
    metadata:
      labels:
        app: clawdbot
    spec:
      # Init container to setup config from K8s secrets if not exists
      initContainers:
        - name: init-config
          image: ghcr.io/zot24/clawdbot-docker:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              CONFIG_DIR=/root/.clawdbot
              CONFIG_FILE=$CONFIG_DIR/clawdbot.json
              AUTH_DIR=$CONFIG_DIR/agents/main/agent
              AUTH_FILE=$AUTH_DIR/auth-profiles.json

              # Create directories
              mkdir -p $CONFIG_DIR $AUTH_DIR

              # Create clawdbot.json if it doesn't exist
              if [ ! -f "$CONFIG_FILE" ]; then
                echo "Creating initial clawdbot.json..."
                cat > $CONFIG_FILE << EOF
              {
                "agents": {
                  "defaults": {
                    "workspace": "/root/clawd"
                  }
                },
                "gateway": {
                  "mode": "local",
                  "port": 18789,
                  "bind": "lan",
                  "auth": {
                    "token": "$GATEWAY_TOKEN"
                  }
                }
              }
              EOF
                chmod 600 $CONFIG_FILE
              else
                echo "clawdbot.json already exists, skipping..."
              fi

              # Create auth-profiles.json if it doesn't exist
              if [ ! -f "$AUTH_FILE" ]; then
                echo "Creating initial auth-profiles.json..."
                cat > $AUTH_FILE << EOF
              {
                "profiles": {
                  "anthropic:claude-cli": {
                    "type": "oauth",
                    "provider": "anthropic",
                    "accessToken": "$CLAUDE_TOKEN"
                  }
                }
              }
              EOF
                chmod 600 $AUTH_FILE
              else
                echo "auth-profiles.json already exists, skipping..."
              fi

              # Create credentials directory
              mkdir -p $CONFIG_DIR/credentials
              chmod 700 $CONFIG_DIR

              echo "Init complete."
          env:
            - name: GATEWAY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: GATEWAY_TOKEN
            - name: CLAUDE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: CLAUDE_TOKEN
          volumeMounts:
            - name: data
              mountPath: /root/.clawdbot
              subPath: config
      containers:
        - name: clawdbot
          # Community image with signal-cli, playwright, etc
          image: ghcr.io/zot24/clawdbot-docker:latest
          imagePullPolicy: Always
          # Run the gateway
          command: ["node"]
          args: ["/app/dist/entry.js", "gateway", "run"]
          ports:
            - name: gateway
              containerPort: 18789
              protocol: TCP
          env:
            - name: NODE_ENV
              value: "production"
            - name: NODE_OPTIONS
              value: "--max-old-space-size=3072"
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: CLAUDE_TOKEN
          volumeMounts:
            - name: data
              mountPath: /root/.clawdbot
              subPath: config
            - name: data
              mountPath: /root/clawd
              subPath: workspace
            - name: data
              mountPath: /root/.local/share/signal-cli
              subPath: signal-cli
          resources:
            requests:
              cpu: 100m
              memory: 2Gi
            limits:
              memory: 4Gi
          livenessProbe:
            httpGet:
              path: /health
              port: gateway
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: gateway
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: clawdbot-data
---
apiVersion: v1
kind: Service
metadata:
  name: clawdbot
  namespace: platform-clawdbot
  labels:
    app: clawdbot
spec:
  type: ClusterIP
  ports:
    - name: gateway
      port: 18789
      targetPort: gateway
  selector:
    app: clawdbot
