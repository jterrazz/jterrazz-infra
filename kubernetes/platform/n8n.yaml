---
# n8n - Workflow Automation Platform
# Self-hosted alternative to Zapier/Make
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: n8n
  namespace: platform-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://8gears.container-registry.com/chartrepo/library
    chart: n8n
    targetRevision: 0.25.2
    helm:
      values: |
        # Persistence
        persistence:
          enabled: true
          storageClass: manual
          size: 1Gi
          existingClaim: n8n-data

        # Resource limits for small VPS
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 512Mi

        # Configuration
        config:
          executions:
            pruneData: "true"
            pruneDataMaxAge: 168  # 7 days in hours

        # n8n specific settings
        extraEnv:
          - name: N8N_PROTOCOL
            value: "https"
          - name: N8N_HOST
            value: "n8n.jterrazz.com"
          - name: WEBHOOK_URL
            value: "https://n8n.jterrazz.com/"
          - name: N8N_EDITOR_BASE_URL
            value: "https://n8n.jterrazz.com/"
          - name: GENERIC_TIMEZONE
            value: "Europe/Paris"

        # Disable built-in ingress (we use Traefik IngressRoute)
        ingress:
          enabled: false

  destination:
    server: https://kubernetes.default.svc
    namespace: platform-automation
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 3m
    syncOptions:
      - CreateNamespace=true
