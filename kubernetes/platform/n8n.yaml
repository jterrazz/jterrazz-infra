---
# n8n - Workflow Automation Platform
# Self-hosted alternative to Zapier/Make
# Self-contained: includes Helm chart + IngressRoute + Certificate
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: n8n
  namespace: platform-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    # Source 1: Helm chart (OCI registry)
    - repoURL: oci://8gears.container-registry.com/library
      chart: n8n
      targetRevision: 2.0.1
      helm:
        values: |
          # Main n8n configuration
          main:
            # Persistence - uses dynamic local-path provisioner
            persistence:
              enabled: true
              type: dynamic
              storageClass: local-path
              size: 1Gi

            # Resource limits for small VPS
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 512Mi

            # n8n configuration
            config:
              executions:
                pruneData: "true"
                pruneDataMaxAge: 168
              generic:
                timezone: "Europe/Paris"
              n8n:
                protocol: "https"
                host: "n8n.jterrazz.com"
                editor:
                  baseUrl: "https://n8n.jterrazz.com/"

          # Disable built-in ingress (we use Traefik IngressRoute)
          ingress:
            enabled: false

          # Disable valkey/redis (not needed for single instance)
          valkey:
            enabled: false
    # Source 2: IngressRoute + Certificate
    - repoURL: https://github.com/jterrazz/jterrazz-infra.git
      targetRevision: HEAD
      path: kubernetes/platform/n8n-resources
  destination:
    server: https://kubernetes.default.svc
    namespace: platform-automation
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 3m
    syncOptions:
      - CreateNamespace=true
