---
# n8n - Workflow Automation Platform
# Self-hosted alternative to Zapier/Make
# Self-contained: includes Helm chart + IngressRoute + Certificate
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: n8n
  namespace: platform-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    # Source 1: Helm chart from community-charts
    - repoURL: https://community-charts.github.io/helm-charts
      chart: n8n
      targetRevision: 1.16.25
      helm:
        values: |
          # Main n8n configuration
          main:
            # Persistence - uses dynamic local-path provisioner
            persistence:
              enabled: true
              storageClass: local-path
              size: 1Gi

            # Resource limits for small VPS
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 512Mi

          # n8n configuration via extraEnvVars
          config:
            executions:
              pruneData: "true"
              pruneDataMaxAge: "168"
            generic:
              timezone: "Europe/Paris"

          # Webhook URL configuration
          n8n:
            encryption_key: ""

          # Disable built-in ingress (we use Traefik IngressRoute)
          ingress:
            enabled: false

          # Disable redis (not needed for single instance)
          redis:
            enabled: false

          # Disable workers (single instance mode)
          worker:
            enabled: false

          # Disable webhook (single instance mode)
          webhook:
            enabled: false
    # Source 2: IngressRoute + Certificate
    - repoURL: https://github.com/jterrazz/jterrazz-infra.git
      targetRevision: HEAD
      path: kubernetes/platform/n8n-resources
  destination:
    server: https://kubernetes.default.svc
    namespace: platform-automation
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 3m
    syncOptions:
      - CreateNamespace=true
