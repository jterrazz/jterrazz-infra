---
# n8n - Workflow Automation Platform
# Self-hosted alternative to Zapier/Make
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: n8n
  namespace: platform-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    # Source 1: Helm chart from community-charts
    - repoURL: https://community-charts.github.io/helm-charts
      chart: n8n
      targetRevision: 1.16.25
      helm:
        values: |
          # Main node configuration
          main:
            editorBaseUrl: "https://n8n.jterrazz.com"
            persistence:
              enabled: true
              existingClaim: n8n-data
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 512Mi

          # Encryption key for credentials (managed via Pulumi/Ansible)
          # Secret created by Ansible with key N8N_ENCRYPTION_KEY
          existingEncryptionKeySecret: "n8n-encryption-key"

          # Timezone configuration
          timezone: "Europe/Paris"

          # Disable built-in ingress (we use Traefik IngressRoute)
          ingress:
            enabled: false
    # Source 2: Additional resources from this folder
    - repoURL: https://github.com/jterrazz/jterrazz-infra.git
      targetRevision: HEAD
      path: kubernetes/platform/n8n
      directory:
        exclude: "app.yaml"
  destination:
    server: https://kubernetes.default.svc
    namespace: platform-automation
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 3m
    syncOptions:
      - CreateNamespace=true
