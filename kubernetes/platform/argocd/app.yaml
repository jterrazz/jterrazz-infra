---
# ArgoCD - GitOps Controller
# Manages itself after bootstrap via Helm
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd
  namespace: platform-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    # Source 1: Helm chart
    - repoURL: https://argoproj.github.io/argo-helm
      chart: argo-cd
      targetRevision: 9.3.5
      helm:
        values: |
          global:
            domain: argocd.local
          configs:
            params:
              server.insecure: true
            cm:
              timeout.reconciliation: 180s
          server:
            ingress:
              enabled: false
          redis:
            resources:
              requests:
                cpu: 15m
                memory: 16Mi
              limits:
                memory: 64Mi
          controller:
            resources:
              requests:
                cpu: 50m
                memory: 192Mi
              limits:
                memory: 512Mi
          repoServer:
            resources:
              requests:
                cpu: 25m
                memory: 100Mi
              limits:
                memory: 384Mi
          applicationSet:
            resources:
              requests:
                cpu: 10m
                memory: 64Mi
              limits:
                memory: 192Mi
          notifications:
            resources:
              requests:
                cpu: 5m
                memory: 32Mi
              limits:
                memory: 96Mi
          dex:
            resources:
              requests:
                cpu: 5m
                memory: 64Mi
              limits:
                memory: 128Mi
          server:
            resources:
              requests:
                cpu: 25m
                memory: 64Mi
              limits:
                memory: 192Mi
    # Source 2: Additional resources from this folder
    - repoURL: https://github.com/jterrazz/jterrazz-infra.git
      targetRevision: HEAD
      path: kubernetes/platform/argocd
      directory:
        exclude: "app.yaml"
    # Source 3: ApplicationSets for user apps
    - repoURL: https://github.com/jterrazz/jterrazz-infra.git
      targetRevision: HEAD
      path: kubernetes/applications
  destination:
    server: https://kubernetes.default.svc
    namespace: platform-gitops
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
