name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Pulumi dependencies
        working-directory: pulumi
        run: npm install

      - name: Pulumi Deploy
        uses: pulumi/actions@v5
        id: pulumi
        with:
          command: up
          stack-name: production
          work-dir: pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: pip install ansible

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ steps.pulumi.outputs.sshPrivateKey }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o ConnectTimeout=5 -i ~/.ssh/id_ed25519 root@${{ steps.pulumi.outputs.serverIp }} "echo ready" && break
            echo "Waiting for SSH... (attempt $i)"
            sleep 10
          done

      - name: Run Ansible
        working-directory: ansible
        run: |
          ansible-playbook playbooks/site.yml \
            -i inventories/production/hosts.yml \
            -e "ansible_host=${{ steps.pulumi.outputs.serverIp }}" \
            -e "ansible_ssh_private_key_file=~/.ssh/id_ed25519" \
            -e "environment_type=production" \
            -e "tailscale_oauth_client_id=${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}" \
            -e "tailscale_oauth_client_secret=${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}"
