name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

jobs:
  validate:
    name: Validate
    uses: ./.github/workflows/validate.yaml
    secrets: inherit

  deploy:
    name: Deploy Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Record start time
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      # --- Pulumi: Provision Infrastructure ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: pulumi/package-lock.json

      - name: Install Pulumi dependencies
        working-directory: pulumi
        run: npm ci

      - name: Pulumi Deploy
        uses: pulumi/actions@v5
        id: pulumi
        with:
          command: up
          stack-name: jterrazz/production
          work-dir: pulumi

      # --- Ansible: Configure Server ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: pip install ansible

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ steps.pulumi.outputs.sshPrivateKey }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Fetch infrastructure secrets from Infisical
        uses: Infisical/secrets-action@v1.0.9
        with:
          method: universal
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          domain: https://eu.infisical.com
          project-slug: jterrazz
          env-slug: prod
          secret-path: /infrastructure

      - name: Wait for SSH
        run: |
          SERVER_IP="${{ steps.pulumi.outputs.serverIp }}"
          echo "Waiting for SSH on $SERVER_IP..."
          for i in {1..30}; do
            if ssh -o ConnectTimeout=5 -i ~/.ssh/id_ed25519 root@$SERVER_IP "echo ready" 2>/dev/null; then
              echo "SSH is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting 10s..."
            sleep 10
          done
          echo "SSH connection failed after 30 attempts"
          exit 1

      - name: Run Ansible Playbook
        working-directory: ansible
        run: |
          ansible-playbook playbooks/site.yml \
            -i inventories/production/hosts.yml \
            -e "ansible_host=${{ steps.pulumi.outputs.serverIp }}" \
            -e "ansible_ssh_private_key_file=~/.ssh/id_ed25519" \
            -e "environment_type=production" \
            -e "tailscale_oauth_client_id=${{ env.TAILSCALE_OAUTH_CLIENT_ID }}" \
            -e "tailscale_oauth_client_secret=${{ env.TAILSCALE_OAUTH_CLIENT_SECRET }}" \
            -e "cloudflare_api_token=${{ env.CLOUDFLARE_API_TOKEN }}" \
            -e "registry_password=${{ env.DOCKER_REGISTRY_PASSWORD }}" \
            -e "portainer_password=${{ env.PORTAINER_ADMIN_PASSWORD }}" \
            -e "n8n_encryption_key=${{ env.N8N_ENCRYPTION_KEY }}" \
            -e "clawdbot_claude_token=${{ env.CLAWDBOT_CLAUDE_TOKEN }}" \
            -e "clawdbot_gateway_token=${{ env.CLAWDBOT_GATEWAY_TOKEN }}" \
            -e "github_pat=${{ env.DEPLOY_PAT }}" \
            -e "github_pat_clawrr=${{ env.DEPLOY_PAT_CLAWRR }}" \
            -e "infisical_client_id=${{ secrets.INFISICAL_CLIENT_ID }}" \
            -e "infisical_client_secret=${{ secrets.INFISICAL_CLIENT_SECRET }}"

      - name: Generate Deployment Summary
        if: always()
        run: |
          # Calculate duration
          START=${{ steps.timer.outputs.start }}
          END=$(date +%s)
          DURATION=$((END - START))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          DURATION_STR="${MINUTES}m ${SECONDS}s"

          # Run deployment summary script
          chmod +x scripts/deployment-summary.sh
          scripts/deployment-summary.sh \
            "${{ steps.pulumi.outputs.serverIp }}" \
            "~/.ssh/id_ed25519" \
            "${{ github.sha }}" \
            "${{ job.status }}" \
            "$DURATION_STR" \
            "${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
