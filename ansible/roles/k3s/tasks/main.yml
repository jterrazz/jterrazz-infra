---
# k3s Installation and Configuration

- name: Check if k3s is installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Get installed k3s version
  ansible.builtin.command: k3s --version
  register: k3s_current_version
  changed_when: false
  failed_when: false
  when: k3s_binary.stat.exists

- name: Determine if k3s needs installation
  ansible.builtin.set_fact:
    k3s_needs_install: "{{ not k3s_binary.stat.exists or (k3s_version not in (k3s_current_version.stdout | default(''))) }}"

# Token Management - Generate once and persist
- name: Check if k3s token file exists
  ansible.builtin.stat:
    path: "{{ k3s_config_dir }}/token"
  register: k3s_token_file

- name: Read existing token
  ansible.builtin.slurp:
    src: "{{ k3s_config_dir }}/token"
  register: k3s_existing_token
  when: k3s_token_file.stat.exists

- name: Generate new token if none exists
  ansible.builtin.command: openssl rand -hex 32
  register: k3s_generated_token
  changed_when: false
  when: not k3s_token_file.stat.exists and k3s_token == ""

- name: Set k3s token fact
  ansible.builtin.set_fact:
    k3s_cluster_token: >-
      {%- if k3s_token != "" -%}
        {{ k3s_token }}
      {%- elif k3s_token_file.stat.exists -%}
        {{ k3s_existing_token.content | b64decode | trim }}
      {%- else -%}
        {{ k3s_generated_token.stdout }}
      {%- endif -%}

- name: Ensure k3s config directory exists
  ansible.builtin.file:
    path: "{{ k3s_config_dir }}"
    state: directory
    mode: "0755"

- name: Save token to file
  ansible.builtin.copy:
    content: "{{ k3s_cluster_token }}"
    dest: "{{ k3s_config_dir }}/token"
    mode: "0600"
  when: not k3s_token_file.stat.exists

# Get Tailscale IP for TLS SAN
- name: Get Tailscale IP
  ansible.builtin.command: tailscale ip -4
  register: k3s_tailscale_ip_result
  changed_when: false
  failed_when: false

- name: Set Tailscale IP fact
  ansible.builtin.set_fact:
    k3s_tailscale_ip: "{{ k3s_tailscale_ip_result.stdout | default('') }}"

# Configuration
- name: Generate k3s config
  ansible.builtin.template:
    src: config.yaml.j2
    dest: "{{ k3s_config_dir }}/config.yaml"
    mode: "0640"
  notify: Restart k3s

# Installation
- name: Download k3s install script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: "0755"
  when: k3s_needs_install

- name: Install k3s
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} sh /tmp/k3s-install.sh
  args:
    creates: /usr/local/bin/k3s
  environment:
    K3S_TOKEN: "{{ k3s_cluster_token }}"
  when: k3s_needs_install
  notify: Restart k3s

- name: Cleanup install script
  ansible.builtin.file:
    path: /tmp/k3s-install.sh
    state: absent

# Service Management
- name: Enable k3s service
  ansible.builtin.systemd:
    name: k3s
    enabled: "{{ k3s_service_enabled }}"
    state: started
    daemon_reload: true

- name: Wait for k3s to be ready
  ansible.builtin.wait_for:
    port: 6443
    host: "{{ k3s_node_ip }}"
    timeout: 120

- name: Verify cluster is running
  ansible.builtin.command: k3s kubectl get nodes
  register: k3s_nodes
  changed_when: false
  retries: 10
  delay: 5
  until: k3s_nodes.rc == 0

# Kubectl Setup
- name: Create kubectl symlink
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link

- name: Set kubeconfig permissions
  ansible.builtin.file:
    path: /etc/rancher/k3s/k3s.yaml
    mode: "0644"

- name: Create .kube directory for root
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    mode: "0700"

- name: Copy kubeconfig for root
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /root/.kube/config
    remote_src: true
    mode: "0600"
# Storage is handled by k3s local-path provisioner
# Data stored in: /var/lib/rancher/k3s/storage/
# No manual directory creation needed - provisioner handles it automatically
