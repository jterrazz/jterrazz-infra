# k3s server configuration
# Generated by Ansible - Jterrazz Infrastructure

# Networking
bind-address: {{ k3s_node_ip }}
https-listen-port: 6443

# Single-node cluster configuration
{% if environment_type not in ['local', 'multipass'] %}
cluster-init: true
{% endif %}
token: {{ k3s_token }}

# Disable built-in components (local-storage now enabled for development!)
{% if k3s_disable_components and k3s_disable_components|length > 0 %}
disable:
{% for component in k3s_disable_components %}
  - {{ component }}
{% endfor %}
{% else %}
# All k3s components enabled (including local-storage for PVCs)
{% endif %}

# Storage configuration
data-dir: {{ k3s_data_dir }}

# API server configuration
write-kubeconfig-mode: "0644"
write-kubeconfig: /etc/rancher/k3s/k3s.yaml

# TLS SANs for API server certificate
tls-san:
{% for san in k3s_server_config['tls-san'] %}
  - {{ san }}
{% endfor %}

# Node configuration
node-ip: {{ k3s_node_ip }}
node-external-ip: {{ k3s_node_ip }}

# Kubelet configuration
kubelet-arg:
  - "max-pods=250"
{% if is_local_environment | default(false) %}

# Local development configuration
# Let K3s handle its own containerd runtime
{% endif %}

# Enable features
kube-apiserver-arg:
  - "enable-admission-plugins=NodeRestriction,ResourceQuota"
