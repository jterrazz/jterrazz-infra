---
# Tailscale Installation and Configuration

- name: Check if Tailscale is installed
  ansible.builtin.stat:
    path: /usr/bin/tailscale
  register: tailscale_binary

- name: Install Tailscale
  when: not tailscale_binary.stat.exists
  block:
    - name: Add Tailscale GPG key
      ansible.builtin.apt_key:
        url: https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg
        keyring: /usr/share/keyrings/tailscale-archive-keyring.gpg
        state: present

    - name: Add Tailscale repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu focal main"
        state: present
        update_cache: true

    - name: Install Tailscale package
      ansible.builtin.apt:
        name: tailscale
        state: present

- name: Enable Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: "{{ tailscale_service_enabled }}"
    state: "{{ tailscale_service_state }}"

- name: Check if already connected to Tailscale
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      tailscale status --json | grep -q '"BackendState":"Running"'
    executable: /bin/bash
  register: tailscale_connected
  changed_when: false
  failed_when: false

- name: Connect to Tailscale
  ansible.builtin.command: >
    tailscale up
    --client-id={{ tailscale_oauth_client_id }}
    --client-secret={{ tailscale_oauth_client_secret }}
    --hostname={{ tailscale_hostname }}
    --advertise-tags={{ tailscale_tags | join(',') }}
    {% if tailscale_advertise_routes %}--advertise-routes={{ tailscale_advertise_routes | join(',') }}{% endif %}
    {% if tailscale_accept_routes %}--accept-routes{% endif %}
    {% if tailscale_accept_dns %}--accept-dns{% endif %}
  when:
    - tailscale_oauth_client_id != ""
    - tailscale_oauth_client_secret != ""
    - tailscale_connected.rc != 0
  changed_when: true

- name: Get Tailscale IP
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip
  changed_when: false
  failed_when: false
