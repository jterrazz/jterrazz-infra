# fail2ban jail configuration - Security Hardened
# Generated by Ansible - Jterrazz Infrastructure

[DEFAULT]
# Ignore IPs (whitelist)
ignoreip = {{ security_fail2ban_ignoreip }}

# Ban settings  
bantime = {{ security_fail2ban_bantime }}
findtime = {{ security_fail2ban_findtime }}
maxretry = {{ security_fail2ban_maxretry }}

# Backend for log parsing
backend = auto

# Email settings (configure if needed)
destemail = root@localhost
sender = root@localhost
mta = sendmail
action = %(action_)s

[sshd]
enabled = true
port = {{ security_ssh_port }}
filter = sshd
logpath = /var/log/auth.log
maxretry = {{ security_fail2ban_maxretry }}
bantime = {{ security_fail2ban_bantime }}

[sshd-ddos]
enabled = true
port = {{ security_ssh_port }}
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 2
bantime = {{ security_fail2ban_bantime }}

# Web server protection (nginx) - only enabled if nginx is installed
{% if ansible_facts.packages is defined and 'nginx' in ansible_facts.packages %}
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 5
bantime = {{ security_fail2ban_bantime }}

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
logpath = /var/log/nginx/error.log
maxretry = 5
bantime = {{ security_fail2ban_bantime }}

[nginx-botsearch]
enabled = true
filter = nginx-botsearch
logpath = /var/log/nginx/access.log
maxretry = 5
bantime = {{ security_fail2ban_bantime }}
{% endif %}

# Additional protections
[recidive]
enabled = true
filter = recidive
logpath = /var/log/fail2ban.log
action = %(action_mwl)s
bantime = 1w
findtime = 1d
maxretry = 5
