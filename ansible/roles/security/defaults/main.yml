---
# Security hardening role default variables

# SSH hardening configuration
security_ssh_port: 22
security_ssh_permit_root_login: "yes" # We need root for initial setup
security_ssh_password_authentication: "no"
security_ssh_pubkey_authentication: "yes"
security_ssh_challenge_response_auth: "no"
security_ssh_gss_api_authentication: "no"
security_ssh_x11_forwarding: "no"
security_ssh_max_auth_tries: 3
security_ssh_client_alive_interval: 300
security_ssh_client_alive_count_max: 2

# fail2ban configuration
security_fail2ban_enabled: true
security_fail2ban_ignoreip: "127.0.0.1/8 ::1"
security_fail2ban_bantime: "10m"
security_fail2ban_findtime: "10m"
security_fail2ban_maxretry: 5

# UFW firewall configuration
security_ufw_enabled: true
security_ufw_default_incoming: "deny"
security_ufw_default_outgoing: "allow"
security_ufw_default_forward: "deny"

# Required firewall rules for our stack
security_ufw_rules:
  - { port: "22", proto: "tcp", rule: "allow", comment: "SSH" }
  - { port: "80", proto: "tcp", rule: "allow", comment: "HTTP (Lets Encrypt)" }
  - { port: "443", proto: "tcp", rule: "allow", comment: "HTTPS" }
  - { port: "6443", proto: "tcp", rule: "allow", comment: "Kubernetes API" }
  - { port: "41641", proto: "udp", rule: "allow", comment: "Tailscale" }

# Automatic updates configuration
security_auto_updates_enabled: true
security_unattended_upgrades_enabled: true
security_auto_reboot_enabled: false # Set to true if you want automatic reboots
security_auto_reboot_time: "06:00"

# System hardening
security_disable_unused_services: true
security_secure_shared_memory: true
security_disable_uncommon_protocols: true

# Kernel parameters for security
security_kernel_parameters:
  # Disable IP forwarding (will be enabled by k3s if needed)
  - { name: "net.ipv4.ip_forward", value: "0" }
  # Disable IPv6 if not needed
  - { name: "net.ipv6.conf.all.disable_ipv6", value: "1" }
  - { name: "net.ipv6.conf.default.disable_ipv6", value: "1" }
  # TCP hardening
  - { name: "net.ipv4.tcp_syncookies", value: "1" }
  - { name: "net.ipv4.icmp_echo_ignore_broadcasts", value: "1" }
  - { name: "net.ipv4.icmp_ignore_bogus_error_responses", value: "1" }
  # Disable source routing
  - { name: "net.ipv4.conf.all.accept_source_route", value: "0" }
  - { name: "net.ipv4.conf.default.accept_source_route", value: "0" }
