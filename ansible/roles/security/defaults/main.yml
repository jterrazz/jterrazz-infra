---
# Security Role - Default Variables

# SSH Configuration
ssh_port: 22
ssh_permit_root_login: "prohibit-password" # Allow root with key only
ssh_password_authentication: "no"
ssh_pubkey_authentication: "yes"
ssh_max_auth_tries: 3
ssh_client_alive_interval: 300
ssh_client_alive_count_max: 2
ssh_allowed_users: [] # Empty = allow all users with valid keys

# Firewall (UFW)
ufw_enabled: true
ufw_default_incoming: "deny"
ufw_default_outgoing: "allow"
ufw_default_forward: "deny"

# Lock SSH to Tailscale only (set to true after Tailscale is confirmed working)
# First deploy needs public SSH access, subsequent deploys use Tailscale
ssh_tailscale_only: false

# Base firewall rules
ufw_rules:
  # HTTP/HTTPS - public
  - { port: "80", proto: "tcp", rule: "allow", comment: "HTTP" }
  - { port: "443", proto: "tcp", rule: "allow", comment: "HTTPS" }
  # Kubernetes API - Tailscale/private only
  - {
      port: "6443",
      proto: "tcp",
      rule: "allow",
      from: "100.64.0.0/10",
      comment: "K8s API (Tailscale)",
    }
  - {
      port: "6443",
      proto: "tcp",
      rule: "allow",
      from: "10.0.0.0/8",
      comment: "K8s API (Private)",
    }
  - {
      port: "6443",
      proto: "tcp",
      rule: "allow",
      from: "172.16.0.0/12",
      comment: "K8s API (Private)",
    }
  - {
      port: "6443",
      proto: "tcp",
      rule: "allow",
      from: "192.168.0.0/16",
      comment: "K8s API (Private)",
    }
  # Docker Registry NodePort - Tailscale only
  - {
      port: "30500",
      proto: "tcp",
      rule: "allow",
      from: "100.64.0.0/10",
      comment: "Registry NodePort (Tailscale only)",
    }

# SSH rules - separate so we can conditionally restrict them
ufw_ssh_rules_public:
  - { port: "22", proto: "tcp", rule: "allow", comment: "SSH (public)" }

ufw_ssh_rules_tailscale:
  - {
      port: "22",
      proto: "tcp",
      rule: "allow",
      from: "100.64.0.0/10",
      comment: "SSH (Tailscale only)",
    }

# Fail2ban
fail2ban_enabled: true
fail2ban_ignoreip: "127.0.0.1/8 ::1"
fail2ban_bantime: "1h"
fail2ban_findtime: "10m"
fail2ban_maxretry: 5

# Automatic Updates
auto_updates_enabled: true
auto_reboot_enabled: false
auto_reboot_time: "06:00"

# System Hardening
secure_shared_memory: true
disable_uncommon_protocols: true

# Kernel Security Parameters
kernel_security_params:
  - { name: "net.ipv4.tcp_syncookies", value: "1" }
  - { name: "net.ipv4.icmp_echo_ignore_broadcasts", value: "1" }
  - { name: "net.ipv4.icmp_ignore_bogus_error_responses", value: "1" }
  - { name: "net.ipv4.conf.all.accept_source_route", value: "0" }
  - { name: "net.ipv4.conf.default.accept_source_route", value: "0" }
  - { name: "net.ipv4.conf.all.rp_filter", value: "1" }
  - { name: "net.ipv4.conf.default.rp_filter", value: "1" }
