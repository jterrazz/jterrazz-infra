---
# JTerrazz Infrastructure - Unified Ansible Playbook
# Works for both production VPS and local Docker development

- name: JTerrazz Infrastructure Setup
  hosts: all
  become: true
  gather_facts: true

  vars:
    # k3s configuration
    k3s_data_dir: "/var/lib/rancher/k3s"
    k3s_config_dir: "/etc/rancher/k3s"

    # Domain configuration - will be set by inventory
    # domain_name: set in inventory files

    # Application versions
    helm_version: "v3.13.3"
    argocd_version: "v2.9.3"
    cert_manager_version: "v1.13.3"
    nginx_ingress_version: "4.8.3"

    # Tailscale
    tailscale_auth_key: "{{ vault_tailscale_auth_key | default('') }}"

  pre_tasks:
    - name: Display deployment environment information
      ansible.builtin.debug:
        msg: |
          {% if environment_type == 'local' %}
          ğŸ  Starting LOCAL DEVELOPMENT deployment
          ğŸ“¦ Target: Docker container ({{ ansible_hostname }})
          ğŸ”§ Environment: {{ environment_type | default('production') }}
          âš ï¸  This is NOT a production deployment!
          {% else %}
          ğŸš€ Starting PRODUCTION deployment
          ğŸ–¥ï¸  Target: {{ ansible_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})
          ğŸ”§ Environment: {{ environment_type | default('production') }}
          ğŸ›¡ï¸ Production security will be applied
          {% endif %}

    - name: Wait for system to be ready (local development)
      ansible.builtin.wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 300
      when: environment_type == 'local'

    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install essential packages
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - unzip
          - ca-certificates
          - gnupg
          - lsb-release
          - python3-pip
          - python3-yaml  # Required for Ansible Kubernetes modules
          - python3-kubernetes  # Required for Ansible Kubernetes modules
          - jq
          - iptables  # Required for k3s networking
        state: present

    - name: Create k3s directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ k3s_config_dir }}"
        - "{{ k3s_data_dir }}"
        - /var/log/k3s

  roles:
    - role: security
      when: not (skip_security | default(false))

    - role: tailscale
      when: not (skip_tailscale | default(false))

    - role: k3s

    - role: helm

    # Removed complex roles - using Traefik built-in instead!
    # - cert-manager: Not needed, Traefik has built-in ACME
    # - nginx-ingress: Not needed, k3s comes with Traefik
    # - argocd: Skip for now, focus on core functionality

    - role: argocd
      when: not (skip_argocd | default(false))

  post_tasks:
    # Skip ArgoCD wait and deployment for now - focusing on core Traefik setup

    - name: Get Tailscale IP if connected
      ansible.builtin.command: tailscale ip -4
      register: tailscale_ip_result
      changed_when: false
      failed_when: false
      when: not (skip_tailscale | default(false))

    - name: Display cluster information
      ansible.builtin.debug:
        msg: |
          ğŸ‰ JTerrazz Infrastructure Setup Complete!

          ğŸ“‹ Summary:
          â€¢ Environment: {{ environment_type | default('local') }}
          â€¢ Target: {{ ansible_hostname }}

          ğŸ”§ Installed Components:
          â€¢ âœ… k3s Kubernetes cluster
          â€¢ âœ… Helm package manager
          â€¢ âœ… Traefik ingress controller (built-in!)

          ğŸš€ Next Steps:
          1. Get kubeconfig: make kubeconfig
          2. Test cluster: kubectl get nodes
          3. Check Traefik: kubectl get pods -n kube-system

          ğŸ¯ Much simpler setup with Traefik! ğŸš€

    - name: Create kubeconfig copy
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{% if environment_type == 'local' %}../local-kubeconfig.yaml{% else %}./kubeconfig{% endif %}"
        flat: true
      delegate_to: "{{ inventory_hostname }}"

    - name: Update kubeconfig server address
      ansible.builtin.replace:
        path: "{% if environment_type == 'local' %}../local-kubeconfig.yaml{% else %}./kubeconfig{% endif %}"
        regexp: 'https://127\.0\.0\.1:6443'
        replace: "{% if environment_type == 'local' %}https://localhost:6443{% else %}https://{{ ansible_host }}:6443{% endif %}"
        backup: false
      delegate_to: localhost
      become: false
