---
# Jterrazz Infrastructure - Main Playbook
# Unified setup for both local development and production VPS

- name: Jterrazz Infrastructure Setup
  hosts: all
  become: true
  gather_facts: true

  vars:
    tailscale_auth_key: "{{ vault_tailscale_auth_key | default('') }}"

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          {{ 'ðŸ  LOCAL DEVELOPMENT' if environment_type == 'local' else 'ðŸš€ PRODUCTION' }} deployment
          Target: {{ ansible_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})

    - name: Wait for system to be ready
      ansible.builtin.wait_for_connection:
        connect_timeout: 20
        timeout: 300
      when: environment_type == 'local'

    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install essential packages
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - unzip
          - ca-certificates
          - gnupg
          - lsb-release
          - python3-pip
          - python3-yaml
          - python3-kubernetes
          - jq
          - iptables
        state: present

    - name: Create k3s directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ k3s_config_dir }}"
        - "{{ k3s_data_dir }}"
        - /var/log/k3s

  roles:
    - role: security
      when: not (skip_security | default(false))

    - role: tailscale
      when: not (skip_tailscale | default(false))

    - role: storage

    - role: k3s

  post_tasks:
    - name: Fetch kubeconfig
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ playbook_dir }}/../{{ 'local-' if environment_type == 'local' else '' }}kubeconfig.yaml"
        flat: true

    - name: Update kubeconfig server address
      ansible.builtin.replace:
        path: "{{ playbook_dir }}/../{{ 'local-' if environment_type == 'local' else '' }}kubeconfig.yaml"
        regexp: 'https://127\.0\.0\.1:6443'
        replace: "https://{{ ansible_host }}:6443"
      delegate_to: localhost
      become: false

    - name: Wait for Traefik to be ready
      ansible.builtin.shell: |
        kubectl wait --for=condition=complete job -l helmcharts.helm.cattle.io/chart=traefik -n kube-system --timeout=1s
      register: traefik_wait
      retries: 60
      delay: 1
      until: traefik_wait.rc == 0
      delegate_to: localhost
      become: false
      environment:
        KUBECONFIG: "{{ playbook_dir }}/../{{ 'local-' if environment_type == 'local' else '' }}kubeconfig.yaml"
      changed_when: false

    - name: Deploy infrastructure components
      ansible.builtin.shell: |
        kubectl apply -k kubernetes/infrastructure/environments/{{ environment_type | default('production') }}
      args:
        chdir: "{{ playbook_dir }}/.."
      delegate_to: localhost
      become: false
      environment:
        KUBECONFIG: "{{ playbook_dir }}/../{{ 'local-' if environment_type == 'local' else '' }}kubeconfig.yaml"
      register: kubectl_result
      changed_when: "'created' in kubectl_result.stdout or 'configured' in kubectl_result.stdout"

    - name: Find ArgoCD application configs
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../kubernetes/applications"
        patterns: "*.yml,*.yaml"
      delegate_to: localhost
      become: false
      register: argocd_apps

    - name: Apply ArgoCD applications
      kubernetes.core.k8s:
        state: present
        src: "{{ item.path }}"
        kubeconfig: "{{ playbook_dir }}/../{{ 'local-' if environment_type == 'local' else '' }}kubeconfig.yaml"
        wait: true
        wait_timeout: 120
      delegate_to: localhost
      become: false
      loop: "{{ argocd_apps.files }}"
      when: argocd_apps.files | length > 0

    - name: Get existing ArgoCD applications
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1alpha1
        kind: Application
        namespace: platform-gitops
        kubeconfig: "{{ playbook_dir }}/../{{ 'local-' if environment_type == 'local' else '' }}kubeconfig.yaml"
      delegate_to: localhost
      become: false
      register: existing_apps

    - name: Remove orphaned ArgoCD applications
      kubernetes.core.k8s:
        api_version: argoproj.io/v1alpha1
        kind: Application
        name: "{{ item.metadata.name }}"
        namespace: platform-gitops
        state: absent
        kubeconfig: "{{ playbook_dir }}/../{{ 'local-' if environment_type == 'local' else '' }}kubeconfig.yaml"
      delegate_to: localhost
      become: false
      loop: "{{ existing_apps.resources | default([]) }}"
      when:
        - existing_apps.resources is defined
        - item.metadata.name not in (argocd_apps.files | map(attribute='path') | map('basename') | map('regex_replace', '\\.(yml|yaml)$', '') | list)

    - name: Setup complete
      ansible.builtin.debug:
        msg: "Setup complete. Run 'make status' to see details."
