---
# Platform Services Playbook
# Deploys Kubernetes infrastructure and ArgoCD applications

- name: Platform Services Deployment
  hosts: all
  become: false
  gather_facts: true

  vars:
    kubeconfig_path: "{{ playbook_dir }}/../../{{ kubeconfig_filename }}"

  tasks:
    - name: Wait for Traefik to be ready
      ansible.builtin.shell: |
        kubectl wait --for=condition=complete job -l helmcharts.helm.cattle.io/chart=traefik -n kube-system --timeout=1s
      delegate_to: localhost
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: traefik_wait
      retries: 60
      delay: 2
      until: traefik_wait.rc == 0
      changed_when: false

    - name: Deploy infrastructure manifests
      ansible.builtin.command:
        cmd: kubectl apply -k kubernetes/infrastructure/environments/{{ environment_type }}
        chdir: "{{ playbook_dir }}/../.."
      delegate_to: localhost
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: infra_result
      changed_when: "'created' in infra_result.stdout or 'configured' in infra_result.stdout"

    - name: Find ArgoCD application manifests
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../kubernetes/applications"
        patterns: "*.yml,*.yaml"
      delegate_to: localhost
      register: argocd_apps

    - name: Apply ArgoCD applications
      kubernetes.core.k8s:
        state: present
        src: "{{ item.path }}"
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 120
      delegate_to: localhost
      loop: "{{ argocd_apps.files }}"
      when: argocd_apps.files | length > 0

    - name: Get existing ArgoCD applications
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1alpha1
        kind: Application
        namespace: platform-gitops
        kubeconfig: "{{ kubeconfig_path }}"
      delegate_to: localhost
      register: existing_apps

    - name: Build list of expected application names
      ansible.builtin.set_fact:
        expected_app_names: "{{ argocd_apps.files | map(attribute='path') | map('basename') | map('regex_replace', '\\.(yml|yaml)$', '') | list }}"

    - name: Remove orphaned ArgoCD applications
      kubernetes.core.k8s:
        api_version: argoproj.io/v1alpha1
        kind: Application
        name: "{{ item.metadata.name }}"
        namespace: platform-gitops
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
      delegate_to: localhost
      loop: "{{ existing_apps.resources | default([]) }}"
      when:
        - existing_apps.resources is defined
        - item.metadata.name not in expected_app_names

    - name: Deployment complete
      ansible.builtin.debug:
        msg: |
          Platform deployment complete!

          Kubeconfig: {{ kubeconfig_path }}
          Run 'make status' to check service status.
